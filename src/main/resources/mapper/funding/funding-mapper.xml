<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="funding">
	<!-- 김윤수 -->
	<select id="selectMyLikeNoList" resultType="_int">
		select funding_no
		from like_record
		where member_no = #{memberNo} and status='Y'
		order by no desc
	</select>
	
	<select id="selectOneFundingKYS" resultMap="fundingVoMap">
		select * 
		from funding
		where funding_no = #{no}
	</select>
	
	<select id="selectOneAttach" resultType="attachment">
		select * 
		from attachment
		where funding_no = #{no}
			  and status ='Y'
	</select>
	
	<select id="selectMyPartiCnt" resultType="_int">
		select count(*)
		from funding_participation
		where member_no = #{memberNo}
	</select>
	
	<select id="selectMyCreateCnt" resultType="_int">
		select count(*)
		from funding
		where writer_no = #{memberNo} and status='Y'
	</select>
	
	<resultMap type="funding" id="fundingVoMap">
		<result column="status" property="status" typeHandler="booleanYnTypeHandler"/>
	</resultMap>
	
	<!-- 김경태 -->
	<!-- 김주연 -->
	<select id="statusYList" resultMap="fundingExtMap">
		select *
		from funding
		where
			<![CDATA[start_date > sysdate]]>
		    and writer_no = #{memberNo}
		    and status = 'Y'
		order by
			funding_no desc
	</select>
	<select id="statusNList" resultMap="fundingExtMap">
		select *
		from funding
		where
		    writer_no = #{memberNo}
		    and status = 'N'
		order by
			funding_no desc
	</select>
	<select id="nowList" resultMap="fundingExtMap">
		select *
		from funding
		where 
		    <![CDATA[start_date < sysdate and d_day > sysdate]]>
		    and writer_no = #{memberNo}
		    and status = 'Y'
		order by
			funding_no desc
	</select>
	<select id="finishList" resultMap="fundingExtMap">
		select *
		from funding
		where
			<![CDATA[start_date < sysdate and d_day < sysdate]]> 
		    and writer_no = #{memberNo}
		    and status = 'Y'
		order by
			funding_no desc
	</select>
	
	<resultMap type="FundingExt" id="fundingExtMap">
		<result column="status" property="status" typeHandler="booleanYnTypeHandler"/>
	</resultMap>
	
	<select id="loadFunding" resultMap="fundingExtMap">
		select *
		from 
			funding 
		where 
			funding_no = #{fundingNo}	
	</select>
	
	<select id="selectCheckFunding" resultMap="fundingExtMap">
		select *
		from 
			funding 
		where 
			funding_no = #{fundingNo}	
	</select>
	
	<insert id="ready1FundingInsertNo">
		insert into
			funding(
				funding_no,
				writer_no,
				reg_date,
				status
			)
			values(
				seq_funding_no.nextval,
				#{writerNo},
				default,
				'N'
			)
		<!--발급받은 funding pk no값을 파라미터 funding객체의 property no에 저장한다.  -->	
		<!--order After 실행된 다음에 가져온다  -->
		<selectKey keyProperty="fundingNo" resultType="_int" order="AFTER">
			select
				seq_funding_no.currval
			from 
				dual
		
		</selectKey>
	</insert>
	<update id="saveCharge">
		update
			funding
		set
			rate_plan_code = #{charge}
		where
			funding_no = #{no}	
	</update>
	<update id="saveBasicInfo">
		update
			funding
		set
			category_code = #{categoryCode},
			title = #{title},
			goal_amount = #{goalAmount},
			d_day = #{dDay}
		where
			funding_no = ${fundingNo}	
	</update>
	<insert id="insertAttachment">
	insert into
		attachment(
			no,
			funding_no,
			originalFilename,
			renamedFilename,
			status
		)
		values(
			seq_attachment_no.nextval,
			#{fundingNo},
			#{originalFilename},
			#{renamedFilename},
			'Y'		
		)
	</insert>
	<update id="updateAttachment">
		update
			attachment
		set
			status = 'N'
		where
			funding_no = #{fundingNo}
	</update>
	
	<update id="saveStory">
		update
			funding
		<set>	
			content = #{content},
			early_content = #{earlyContent},
			start_date = #{startDate}		
		</set>	
		where
			funding_no = #{fundingNo}	
	</update>
	
	<select id="loadReward" resultType="reward">
		select
			*
		from
			funding_reward
		where
			funding_no=#{fundingNo}
	</select>
	
	<select id="selectOneReward" resultType="reward">
		select
			*
		from
			funding_reward
		where
			reward_no=#{rewardNo}
	</select>
	
	<insert id="insertReward">
		insert into
			funding_reward(
				reward_no,
				funding_no,
				price,
				title,
				content,
				shipping_price,
				limit_amount,
				shipping_date
			)
			values(
				seq_funding_reward_no.nextval,
				#{fundingNo},
				#{price},
				#{title},
				#{content},
				#{shippingPrice},
				#{limitAmount},
				#{shippingDate}		
			)
		
	</insert>
	
	<update id="updateReward">
		update
			funding_reward
		<set>
			price = #{price},
			title = #{title},
			content = #{content},
			shipping_price = #{shippingPrice},
			limit_amount = #{limitAmount},
			shipping_date = #{shippingDate}
		</set>
		where 
			funding_no = #{fundingNo}
	</update>
	
	<delete id="deleteReward">
		delete from funding_reward
		where
			reward_no = #{rewardNo}
	</delete>
	
	<update id="finalSubmit">
		update
			funding
		set
			status = 'Y'
		where
			funding_no = #{fundingNo}
	</update>
	
	<update id="finalNSubmit">
		update
			funding
		set
			status = 'N'
		where
			funding_no = #{fundingNo}
	</update>
	
	<delete id="deleteFunding">
		delete from funding
		where 
			funding_no =#{fundingNo}
	</delete>
	
	
	
	
	
	<!-- 박요한 -->
	<select id="fundingNews" resultMap="fundingExtMap">
		select *
        from funding F 
            join funding_board R 
            on F.funding_no = R.funding_no
            join member M
            on F.writer_no = M.member_no
        where F.funding_no = #{funding_no}
	</select>
	
	
	<select id="community" resultMap="fundingExtMap">
		select *
        from funding_comment
        where comment_no = #{commet_no}
	</select>
	
	
	<select id="supporter" resultMap="fundingExtMap">
		select *
        from funding F 
            join funding_participation R 
            on F.funding_no = R.funding_no
            join member M
            on F.writer_no = M.member_no
        where F.funding_no = #{funding_no}
	</select>
	<insert id="insertComment">
		insert into
			funding_comment(
				comment_no,
				content
			)
		values(
			seq_funding_comment_no.nextval,
			#{content}
		)
	</insert>
	<select id="newsView" resultMap="fundingExtMap">
		select *
        from funding F 
            join funding_board R 
            on F.funding_no = R.funding_no
            join member M
            on F.writer_no = M.member_no
        where F.funding_no = #{funding_no}
	</select>
	<!-- 배기원 -->
		<select id="indexfundingList" resultMap="fundingVoMap">
		select rownum, f.*
			from (
			        select funding.* 
		        	from funding  
		        	where <![CDATA[ start_date < sysdate and d_day > sysdate]]>
		        		  and status ='Y'
		       		order by reg_date  desc
		        ) f
		where rownum between 1 and 6
	    </select>
	    <select id="indexviewlist" resultMap="fundingVoMap">
			select rownum, f.*
			from (
			        select funding.* 
			        from funding  
			        where <![CDATA[start_date < sysdate and d_day > sysdate]]>
			        	  and status ='Y'
			        order by readcount  desc
			        ) f
			where rownum between 1 and 4
	    </select>
	    
	    <select id="indexfundinglike" resultMap="fundingVoMap">
			select rownum, f.*
			from (
			        select *
			        from funding   
			      	where <![CDATA[ start_date < sysdate and d_day > sysdate]]>
			      		  and status ='Y'
			        order by like_count desc
		        ) f
			where rownum between 1 and 5
	    </select>
	    
	    <select id="indexTotalContents" resultType="_int">
	    	select
				count(*)
		from
			funding
		where 
	       start_date<![CDATA[> ]]>sysdate 
	    </select>
	    
	    <!-- <select id="indexEarlyList" resultMap="fundingVoMap">
		    select*from funding 
	    where 
	       start_date<![CDATA[> ]]>sysdate 
	    </select> -->
	    
	    <select id="indexlikelist" resultMap="fundingVoMap" >
	    	select  
		rownum, f.*
		from (
		        select funding.* ,
		         CASE category_code
		         WHEN 'C1' THEN '테크.가전'
		         WHEN 'C2' THEN '푸드'
		         WHEN  'C3' THEN '여행'
		         WHEN  'C4' THEN '스포츠'
		         WHEN 'C5' THEN '게임.취미'
		         WHEN 'C6' THEN '모임'
		         WHEN  'C7' THEN  '반려동물'
		         WHEN  'C8' THEN '기부.후원'
		         END as categoryName  
		        from funding  
		        where<![CDATA[ start_date < sysdate and d_day > sysdate]]>
		        order by like_count  desc
		        ) f
		where rownum between 1 and 5
	    </select>
	    
	    <select id="indexfundingRefresh" resultMap="fundingVoMap">
			    select rownum, f.*
				from (
				        select funding.* 
				        from funding  
				        where <![CDATA[ start_date < sysdate and d_day > sysdate]]>
				        	  and status = 'Y'
				        order by start_date  desc
		        ) f
		where rownum between 1 and 6
	    </select>
	<!-- 이승우 -->
	<!-- searchKeyword searchSelect1 searchSelect2 category -->
	<!-- processing selected(진행중 종료) recent recommand (최신순 과거순) -->
	<select id="selectFundingList" resultMap="fundingVoMap">
		select *
		from funding
		<where>
			status = 'Y'
			and title like '%' || #{searchKeyword} || '%' 
			and start_date <![CDATA[<]]> sysdate
			<if test="category != null and category != ''">
			and category_code like '%' || #{category} || '%'
			</if>
			<if test="searchSelect1 == 'processing'">
			and d_day <![CDATA[>]]> sysdate
			</if>
			<if test="searchSelect1 == 'quit'">
			and d_day <![CDATA[<]]> sysdate
			</if>
		</where>
		<if test="searchSelect2 == 'recent'">
		order by reg_date desc
		</if>
		<if test="searchSelect2 == 'recommand'">
		order by like_count desc
		</if>
	</select>

	<select id="selectFundingListTotalContents" resultType="_int">
		select
			count(*)
		from funding
		<where>
			status = 'Y'
			and title like '%' || #{searchKeyword} || '%' 
			and start_date <![CDATA[<]]> sysdate
			<if test="category != null and category != '' and category != 'C0'">
			and category_code like '%' || #{category} || '%'
			</if>
			<if test="searchSelect1 == 'processing'">
			and d_day <![CDATA[>]]> sysdate
			</if>
			<if test="searchSelect1 == 'quit'">
			and d_day <![CDATA[<]]> sysdate
			</if>
		</where>
	</select>
	<select id="selectEarlyList" resultMap="fundingVoMap">
		select * 
		from funding
		<where>
			status = 'Y'
			and start_date <![CDATA[>]]> sysdate
		</where>
	</select>
	<!-- 천호현 -->
    
    <select id="selectOneFunding" resultMap="fundingExtMap">
        select *
        from funding
        where funding_no = #{fundingNo}
    </select>
    
    <select id="fundingParticipationCount" resultType="_int">
        select count(*) count
        from funding_participation
        where funding_no = #{fundingNo}
    </select>
    
    <select id="likeCheck" resultMap="likeMap">
    	select *
    	from like_record
    	where member_no = #{memberNo} and funding_no = #{fundingNo}
    </select>
	   
	<insert id="insertLike">
		insert into like_record
		values (seq_like_record_no.nextval, #{fundingNo}, #{memberNo}, 'Y')
	</insert>
	
	<resultMap type="map" id="likeMap">
		<id column="no" property="no"/>
		<result column="status" property="status" typeHandler="booleanYnTypeHandler"/>
		<result column="funding_no" property="fundingNo"/>
		<result column="member_no" property="memberNo"/>
	</resultMap>
	
	<update id="updateLike">
		update like_record
		set status = #{status, typeHandler=booleanYnTypeHandler}
		where no = #{no}
	</update>
	
	<select id="likeCount" resultType="_int">
		select count(*)
		from like_record
		where funding_no = #{fundingNo} and status = 'Y'
	</select>
	
	
	<select id="likeStatusCheck" resultType="_int">
		select count(*)
		from like_record
		where member_no = #{memberNo} and status = 'Y'
	</select>
	
	<select id="selectRewardList" resultType="reward">
		select
			*
		from
			funding_reward
		where
			funding_no = #{fundingNo}
	</select>
</mapper>