<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="funding">
	<!-- 김윤수 -->
	<!-- 김경태 -->
	<!-- 김주연 -->
	<select id="statusYList" resultMap="fundingMap">
		select
			f.*, 
			(select name 
            		from member 
            where member_no = f.writer_no)name
		from
			funding f
        
		where
			f.writer_no = 21
			and f.status = 'Y'
	</select>
	<select id="statusNList" resultMap="fundingMap">
		select
			f.*, 
			(select name 
            		from member 
            where member_no = f.writer_no)name
		from
			funding f
        
		where
			f.writer_no = 21
			and f.status = 'N'
	</select>
	<resultMap type="FundingExt" id="fundingMap">
		<result column="status" property="status" typeHandler="booleanYnTypeHandler"/>
	</resultMap>
	<insert id="ready1FundingInsertNo">
		insert into
			funding(
				funding_no,
				writer_no
			)
			values(
				seq_funding_no.nextval,
				${writerNo}
				
			)
		<!--발급받은 funding pk no값을 파라미터 funding객체의 property no에 저장한다.  -->	
		<!--order After 실행된 다음에 가져온다  -->
		<selectKey keyProperty="fundingNo" resultType="_int" order="AFTER">
			select
				seq_funding_no.currval
			from 
				dual
		
		</selectKey>
	</insert>
	<update id="saveCharge">
		update
			funding
		set
			rate_plan_code = '${charge}'
		where
			funding_no = ${no}	
	</update>
	<update id="saveBasicInfo">
		update
			funding
		set
			category_code = '${categoryCode}',
			title = '${title}',
			goal_amount = ${goalAmount},
			reg_date = default,
			d_day = ${dDay}
		where
			funding_no = ${fundingNo}	
	</update>
	<insert id="insertAttachment">
	insert into
		attachment(
			no,
			funding_no,
			original_filename,
			renamed_filename
		)
		values(
			seq_attachment_no.nextval,
			${fundingNo},
			${originalFilename},
			${renamedFilename}
		
		)
	</insert>
	
	<update id="saveStory">
		update
			funding
		<set>
		
			content = ${content},
		
			early_content = ${earlyContent},
			
		
			start_date = ${startDate}
				
		</set>	
		where
			funding_no = ${fundingNo}	
	</update>
	
	<update id="finalSubmit">
		update
			funding
		set
			status = 'Y'
		where
			funding_no = ${fundingNo}
	</update>
	
	
	<!-- 박요한 -->
	<!-- 배기원 -->
<!--  <resultMap type="fundingExt" id="fundingMap">
		<id column="no" property="no"></id>
		<result column="title" property="title"/>
		<result column="category_code" property="category_code"/>
		<result column="now_amount" property="now_amount"/>
		<result column="goal_amount" property="goal_amount"/>
		<result column="rate_plan_code" property="rate_plan_code"/>
		<result column="writer_no" property="writer_no"/>
		<result column="readcount" property=""/>
	</resultMap> -->
		<select id="indexfundingList" resultType="funding">
				select rownum, f.*
		from (
		        select *
		        from funding  
		        where <![CDATA[ start_date < sysdate and d_day > sysdate]]>
		        order by reg_date  desc
		        ) f
		where rownum between 1 and 6
	    </select>
	    
	    <select id="indexfundinglike" resultType="funding">
			    	select rownum, f.*
		from (
		        select *
		        from funding   
		      where <![CDATA[ start_date < sysdate and d_day > sysdate]]>
		        order by like_count desc
		        ) f
		where rownum between 1 and 5
	    </select>
	<!-- 이승우 -->
	<select id="selectFundingList" resultType="funding">
		select
			*
		from
			funding f
		<where>
			title like '%' || '${searchKeyword}' || '%'
			<if test="searchSelect1 == 'processing'">
			and d_day <![CDATA[>]]> sysdate
			</if>
			<if test="searchSelect1 == 'quit'">
			and d_day <![CDATA[<]]> sysdate
			</if>
		</where>
		<if test="searchSelect2 == 'recent'">
		order by reg_date desc
		</if>
		<if test="searchSelect2 == 'recommand'">
		order by like_count desc
		</if>
	</select>
	<!-- 천호현 -->
	<select id="selectFunding" resultMap="fundingVoMap">
		select *
		from funding F
		    join funding_reward R
		    on F.funding_no = R.funding_no
		    join attachment A
		    on f.funding_no = A.funding_no
		    join like_record L
		    on L.funding_no = F.funding_no
		where f.funding_no =#{funding_no}
	</select>
	<select id="selectOneFunding" resultType="funding">
		select
			*
		from
			funding
		where
			funding_no = #{funding_no}
	</select>
	
	<resultMap type="fundingExt" id="fundingVoMap">
	
	</resultMap>
</mapper>
